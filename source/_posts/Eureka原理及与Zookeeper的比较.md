---
title: Eureka原理及与Zookeeper的比较
date: 2019-08-02 17:12:45
tags: [Eureka,Zookeeper,注册中心]
categories: [微服务]
---


*Eureka*是Netflix开源的一款提供服务注册和发现的产品，它提供了完整的Service Registry和Service Discovery实现。也是springcloud体系中最重要最核心的组件之一。目前1.X版本已停止维护，2.X版本未开源。

*ZooKeeper*是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。

<!-- more -->
#### Eureka原理

服务启动后向Eureka注册，Eureka Server会将注册信息想其它Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，然后会将服务提供者地址缓存在本地，下次再调用时，则直接从本地缓存中取，完成一次调用。

当服务注册中心Eureka Server检测到服务提供者因为宕机、网络原因不可用时，则在服务注册中心将服务置为`DOWN`状态，并把当前服务提供者状态向订阅者发布，订阅过的服务消费者更新本地缓存。

服务提供者在启动后，周期性（默认30秒）向Eureka Server发送心跳，以证明当前服务是可用状态。Eureka Server在一定的时间（默认90秒）未收到客户端的心跳，则认为服务宕机，注销该实例。



#### 作为注册中心

##### Zookeeper 保证CP

当向注册中心查询服务列表时，我们可以容忍注册中心返回的事几分钟以前的注册信息，但不能接受服务直接宕掉不可用。也就是说，服务注册功能对可用性的要求要高于一致性。但是zk会出现这样一种情况，当master节点因为网络故障与其它几点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30～120s，且选举期间整个zk集群都是不可用的，这就导致在选举期间注册服务瘫痪。

在使用dubbo作为微服务框架，zookeeper作为注册中心时，由于服务提供者的信息时缓存在服务消费者本地的，所以当zk宕机不可用时，服务之间也是可以进行正常的服务调用的，不过由于zk不提供服务注册，无法与刚启动的服务进行服务通讯。

##### Eureka保证AP

Eureka在设计时有限保证可用性。Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而且Eureka的客户端在向某个Eureka注册时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就可以保证服务可用，只不过查到的信息不是最新的（不保证强一致性）。除此之外，Eureka还有一种自我保护机制，如果15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心除了网络故障，此时会出现一下几种情况：

1. Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务
2. Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它几点
3. 当网络稳定时，当前实例新的注册信息会被同步至其它节点